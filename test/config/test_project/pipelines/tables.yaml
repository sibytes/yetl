
version: 1.4.9
# deltalake table properties
# https://docs.databricks.com/delta/table-properties.html

# delta.appendOnly: false
# delta.autoOptimize.autoCompact: none    
# delta.autoOptimize.optimizeWrite: none    
# delta.checkpoint.writeStatsAsJson: true
# delta.checkpoint.writeStatsAsStruct: none
# delta.columnMapping.mode: false
# delta.compatibility.symlinkFormatManifest.enabled: false
# delta.dataSkippingNumIndexedCols 32
# delta.deletedFileRetentionDuration: interval 1 week
# delta.enableChangeDataFeed: false
# delta.isolationLevel:  WriteSerializable
# delta.logRetentionDuration: interval 30 days
# delta.minReaderVersion: 1
# delta.minWriterVersion: 2
# delta.randomizeFilePrefixes: false
# delta.randomPrefixLength: 2
# delta.setTransactionRetentionDuration: none
# delta.tuneFileSizesForRewrites: none

# captures any audit tables you may
# want to create to capture details of the ETL process
# such as watermarks, stats etc
# audit_control:
#   delta_lake:
#     raw_dbx_patterns_control:
#       header_footer:
#         sql: ../sql/{{database}}/{{table}}.sql
#         depends_on:
#           - raw.raw_dbx_patterns.customers
#       raw_audit:
#         sql: ../sql/{{database}}/{{table}}.sql
#         depends_on:
#           - raw.raw_dbx_patterns.customers

audit_control:
  delta_lake:
    raw_dbx_patterns_control:
      header_footer:
        sql: ../sql/{{database}}/{{table}}.sql
        depends_on:
          - raw.raw_dbx_patterns.*
      raw_audit:
        sql: ../sql/{{database}}/{{table}}.sql
        depends_on:
          - raw.raw_dbx_patterns.*
          - audit_control.raw_dbx_patterns_control.header_footer

landing:
  read:
    landing_dbx_patterns:
      customer_details_1: null
      customer_details_2: null

raw:
  delta_lake:
    raw_dbx_patterns:
      customers:
        id: id
        depends_on:
          - landing.landing_dbx_patterns.customer_details_1
          - landing.landing_dbx_patterns.customer_details_2
        warning_thresholds:
          invalid_ratio: 0.1
          invalid_rows: 0
          max_rows: 100
          min_rows: 5
        exception_thresholds:
          invalid_ratio: 0.2
          invalid_rows: 2
          max_rows: 1000
          min_rows: 0
        custom_properties:
          process_group: 1
        z_order_by:
          - _load_date_1
          - _load_date_2
        vacuum: 30


base:
  delta_lake:
    # delta table properties can be set at stage level or table level
    delta_properties:
      delta.appendOnly: true
      delta.autoOptimize.autoCompact: true    
      delta.autoOptimize.optimizeWrite: true  
      delta.enableChangeDataFeed: false
    base_dbx_patterns:
      customer_details_1:
        id: id
        depends_on:
          - raw.raw_dbx_patterns.customers
        # delta table properties can be set at stage level or table level
        # table level properties will overwride stage level properties
        delta_properties:
            delta.enableChangeDataFeed: true
      customer_details_2:
        id: id
        depends_on:
          - raw.raw_dbx_patterns.customers


